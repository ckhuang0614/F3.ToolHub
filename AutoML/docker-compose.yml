version: "3.8"

x-clearml-env: &clearml-env
  CLEARML_API_HOST: http://clearml-apiserver:8008
  CLEARML_WEB_HOST: http://clearml-webserver:8080
  CLEARML_FILES_HOST: http://clearml-fileserver:8081

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.18
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"

  mongodb:
    image: mongo:5
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db
    ports:
      - "27017:27017"

  redis:
    image: redis:6
    restart: unless-stopped
    ports:
      - "6379:6379"

  clearml-apiserver:
    image: allegroai/clearml:1.13
    depends_on:
      - mongodb
      - redis
      - elasticsearch
    environment:
      - CLEARML_API_HOST=0.0.0.0
      - CLEARML_API_PORT=8008
      - CLEARML_WEB_HOST=http://clearml-webserver:8080
      - CLEARML_FILES_HOST=http://clearml-fileserver:8081
      - CLEARML_MONGODB_SERVICE_HOST=mongodb
      - CLEARML_MONGODB_SERVICE_PORT=27017
      - CLEARML_ELASTIC_SERVICE_HOST=elasticsearch
      - CLEARML_ELASTIC_SERVICE_PORT=9200
      - CLEARML_REDIS_SERVICE_HOST=redis
      - CLEARML_REDIS_SERVICE_PORT=6379
    ports:
      - "8008:8008"
    command: ["apiserver"]
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8008/debug.ping', timeout=2).read()"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s

  clearml-webserver:
    image: allegroai/clearml:1.13
    depends_on:
      - clearml-apiserver
    environment:
      - NGINX_APISERVER_ADDRESS=http://clearml-apiserver:8008
      - NGINX_FILESERVER_ADDRESS=http://clearml-fileserver:8081
      - CLEARML_WEB_HOST=0.0.0.0
      - CLEARML_WEB_PORT=8080
    ports:
      - "8080:80"
    command: ["webserver"]

  clearml-fileserver:
    image: allegroai/clearml:1.13
    depends_on:
      - clearml-apiserver
    environment:
      - CLEARML_FILES_HOST=0.0.0.0
      - CLEARML_FILES_PORT=8081
    ports:
      - "8081:8081"
    volumes:
      # Persist uploaded artifacts so they survive container restarts
      - fileserver-data:/mnt/fileserver
    command: ["fileserver"]

  minio:
    image: bitnamilegacy/minio:2024
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_DEFAULT_BUCKETS=datasets:public
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    environment:
      <<: *clearml-env
      CLEARML_API_ACCESS_KEY: ${CLEARML_API_ACCESS_KEY:-P4BMJA7RK3TKBXGSY8OAA1FA8TOD11}
      CLEARML_API_SECRET_KEY: ${CLEARML_API_SECRET_KEY:-9LsgSfa0SYz0zli1_c500ZcLqanre2xkWOpepyt1w-BKK3_DKPHrtoj3JSHvyy8bIi0}
      CLEARML_DEFAULT_QUEUE: ${CLEARML_DEFAULT_QUEUE:-default}
      AUTOGLOUON_IMAGE: ${AUTOGLOUON_IMAGE:-f3.autogluon-trainer:latest}
      FLAML_IMAGE: ${FLAML_IMAGE:-f3.flaml-trainer:latest}
      YOLO_IMAGE: ${YOLO_IMAGE:-f3.yolo-trainer:latest}
    ports:
      - "8000:8000"
    depends_on:
      - clearml-apiserver
      - clearml-webserver
      - clearml-fileserver

  clearml-agent:
    build:
      context: ./infra
      dockerfile: clearml-agent/Dockerfile
    privileged: true
    environment:
      <<: *clearml-env
      CLEARML_API_ACCESS_KEY: ${CLEARML_API_ACCESS_KEY:-P4BMJA7RK3TKBXGSY8OAA1FA8TOD11}
      CLEARML_API_SECRET_KEY: ${CLEARML_API_SECRET_KEY:-9LsgSfa0SYz0zli1_c500ZcLqanre2xkWOpepyt1w-BKK3_DKPHrtoj3JSHvyy8bIi0}
      CLEARML_CONFIG_FILE: /root/clearml.conf
      TRAINS_CONFIG_FILE: /root/clearml.conf
      CLEARML_AGENT_DOCKER_RUNTIME: ${CLEARML_AGENT_DOCKER_RUNTIME:-}
      CLEARML_AGENT_EXTRA_DOCKER_ARGS: ${CLEARML_AGENT_EXTRA_DOCKER_ARGS:---network automl_default -e CLEARML_API_ACCESS_KEY -e CLEARML_API_SECRET_KEY -e CLEARML_API_HOST -e CLEARML_WEB_HOST -e CLEARML_FILES_HOST -e AWS_ACCESS_KEY_ID=minioadmin -e AWS_SECRET_ACCESS_KEY=minioadmin -e AWS_DEFAULT_REGION=us-east-1 -e AWS_ENDPOINT_URL=http://minio:9000 -e CLEARML_PATCH_PYTORCH=0 -e CLEARML_AGENT_SKIP_PYTHON_ENV_INSTALL=1 --shm-size=1g}
      CLEARML_WORKER_NAME: docker-agent
      CLEARML_AGENT_SKIP_PYTHON_ENV_INSTALL: "true"
      CLEARML_AGENT_USE_LEGACY_HASH: "true"
      CLEARML_LOG_LEVEL: INFO
      CLEARML_AGENT_DEFAULT_QUEUE: ${CLEARML_DEFAULT_QUEUE:-default}
    volumes:
      - ./infra/clearml/clearml.conf:/root/clearml.conf:ro
      - ./.clearml-host:/clearml_host
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      clearml-apiserver:
        condition: service_healthy
      clearml-webserver:
        condition: service_started
      clearml-fileserver:
        condition: service_started
    command: ["daemon", "--queue", "${CLEARML_DEFAULT_QUEUE:-default}", "--docker", "--foreground"]

  autogluon-trainer:
    build:
      context: .
      dockerfile: trainers/autogluon/Dockerfile
    image: f3.autogluon-trainer:latest
    profiles: ["build-only"]

  flaml-trainer:
    build:
      context: .
      dockerfile: trainers/flaml/Dockerfile
    image: f3.flaml-trainer:latest
    profiles: ["build-only"]

  yolo-trainer:
    build:
      context: .
      dockerfile: trainers/yolo/Dockerfile
    image: f3.yolo-trainer:latest
    profiles: ["build-only"]

volumes:
  es-data:
  mongo-data:
  minio-data:
  fileserver-data:
